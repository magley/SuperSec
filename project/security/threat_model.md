# Lesotho модел претњи

## Мотивација нападача

Lesotho сервис је подложан нападу од стране разних малициозних актера. Утицај
зависи од других сервиса који користе Lesotho за ауторизацију. Претпоставимо да
се Lesotho користи у склопу велике мреже сервиса налик оним које Google има (то
јест, имамо своју варијанту Docs, Sheets, Slides, YouTube, Gmail, Drive и Cloud
сервиса).

### Script kiddie
 
- ниво вештине: врло низак
- крајњи циљ: елевација привилегија
- приступ: експериментисање са URL параметрима захтева у различитим сервисима

### Индијац

- ниво вештине: низак/средњи
- крајњи циљ: приступ функционалностима у Cloud сервису за које иначе нема приступ, или измена садржаја туђег Drive-а
- приступ: phishing ради добављања креденцијала других корисника, social engineering

### Влада стране државе

- ниво вештине: висок
- крајњи циљ: читање туђих мејлова, dump приватних података, breach базе података 
- приступ: ??? 

### Конкуренција

- ниво вештине: варира
- крајњи циљ: рушење нашег система, увид у архитектуру
- приступ: DDOS, reverse engineering, шпијунажа 

## Асети

### Сервис

- изложеност: **средња**. Ово је централна компонента у Lesotho пројекту. Директан приступ имају споредни сервиси. Корисници користе ове споредне сервисе као посредник ка Lesotho.

- безбедносни циљеви:
    - Integrity - ACL листе не смеју да буду промењене од стране малициозног актера
    - Availability - сервис мора бити доступан 24/7

- утицај:
    - Integrity - елевација привилегија, закључавање корисника од својих датотека
    - Availability - пад система, лош UX, губитак корисника и профита

## Површина напада

Напомена: Физичке површине напада се не разматрају под претпоставком да унутар компаније немамо малициозне актере и да је опрема довољно добро заштићена (и довољно дистрибуирана да ниједан од CIA не може бити компромитован нападом на један уређај). 
Ипак, неке од њих су наведене:
- извађени хард дискови
- USB и други периферни портови
- приступ сервер рачунарима
- лозинке и други приватни подаци писани на папирићима

### Lesotho

Lesohto сервису корисници немају директан приступ. Он није отворен за web захтеве са Интернета. Једино програмери и системски администратори, који су у интерној мрежи где се и сам Lesotho налази, могу да шаљу захтеве овом сервису.

Са сервисом комуницирају апликације.

API
- ажурирање namespace-а
- ажурирање ACL-a
- упит за ACL

Фајлови
- Consul
- LevelDB

Хадрвер
- дискови
- рачунари

### API Server 2

Корисници имају директан приступ преко CLI апликације.

API
- пријава
- регистрација
- добављање свих корисника
- добављање свих докумената (**ризично**)
- креирање новог документа
- провера пермисије према документу
- дељење документа
- додавање текста у документ
- добављање документа

Фајлови
- подаци о корисницима
- подаци о документима (**ризично**)

Хардвер
- дискови
- рачунари

## Идентификација претњи

**Категорије (STRIDE)**: Spoofing, Tampering, Repudiation, Info Disclosure, Denial of Service, Elevation of Privelege

**Компоненте**: Web App, Cli App, API Server, API2 Server, Lesotho, LevelDB, Consul

**Likelihood**: веродостојност злоупотребе, [0.0, 1.0]

**Impact**: утицај, [1, 2, 3, 4, 5]

**Ocena** = `Likelihood * Impact`

| #  | Категорија | Опис | Компонента | Likelihood | Impact | Ocena |
|----|------------|------|------------|------------|--------|-------|
| 01 | I | No HTTPs | Све | 1,0 | 5 | 5,0 |
| 02 | D | No rate limiting | Lesotho | 0,25 | 5 | 1,25 |
| 03 | S, E | Invalid token auth | API2 | 0,8 | 3 | 2,4 |
| 04 | R | No logging | * | 0,75 | 2 | 1,5 |
| 05 | I, D | No API keys | Lesotho | 1,0 | 4 | 4,0 | 
| 06 | T, I | No sandboxing | Lesotho, API, API2, LevelDB, Consul | 0.275 | 3 | 0,825 |
| 07 | T | ConsulDB tampering | Consul | 0,13375 | 4 | 0,535
| 08 | D | No Captcha | Web App, Cli App(?) | 0,7 | 2 | 1,4 |
| 09 | S | No MFA | API, API2 | 0,8 | 4 | 3,2 |

## Анализа и митигација

**Одговор ([по Шостаку](https://shostack.org/resources/threat-modeling))**: Mitigation, Elimination, Transfer, Accept.

| #  | Одговор | Опис              |
|----|---------|-------------------|
| 01 | M | Имплементирати HTTPs. API и API2 користе Flask; HTTPs се уграђује [овако](https://stackoverflow.com/a/29464090). Поред тога, препорука је да се HTTPs угради и у интерне сервисе. Некада Google ово није радио, што је омогућило "лицима са ауторитетом" да читају податке. HTTPs се у Go сервер уграђује [овако](https://stackoverflow.com/a/46992083). Поред тога, може се користити радни оквир попут Gorilla. У Consul се HTTPs уграђује [овако](https://developer.hashicorp.com/consul/tutorials/archive/tls-encryption-openssl-secure). За почетак се може користити LetsEncrypt сертификати. |
| 02 | M | Користити агент за rate limiting (nginx). |
| 03 | M | Криптографски потписати токене након аутентификације и проверавати токен пре обраде сваког захтева. |
| 04 | M | Имплементирати безбедно логовање свих компоненти система. |
| 05 | M | Увести механизам за идавање API кључева сервисима који желе да користе Lesotho. Кључеви би требало да имају рок трајања који се потенцијално може аутоматски обновити. |
| 06 | M | Виртуелизација, издвајање у одвојене сервер рачунаре, контејнеризација. |
| 07 | A | Изван коришћења HTTPs и праћења препорука за безбедно руковање са Consul сервисом, не може се учинити много по разумној цени. |
| 08 | M | Увести капчу. |
| 09 | M | Имплементирати вишефакторску аутентификацију.  |